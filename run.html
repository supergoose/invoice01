<html>
    <head>
        <title>Main Slideshow</title>

        <!-- CSS -->
        <link rel="stylesheet" href="lib/css/jquery.maximage.css" type="text/css" media="screen" title="CSS" charset="utf-8" />
        
        <!-- JS -->
        <script type="text/javascript" src="lib/js/mousetrap.js"></script>
        <script src="lib/js/jquery.js"></script>
        <script src="lib/js/jquery.cycle.all.js" type="text/javascript"></script>
        <script src="lib/js/jquery.easing.1.3.js" type="text/javascript"></script>
        <script src="lib/js/jquery.maximage.min.js" type="text/javascript"></script>
        
        <style type="text/css" media="screen">
			/* I wanted to center my loader */
			#cycle-loader {
				height:32px;
				left:50%;
				margin:-8px 0 0 -8px;
				position:absolute;
				top:50%;
				width:32px;
				z-index:999;
			}
			
			/*I want to avoid jumpiness as the JS loads, so I initially hide my cycle*/
			#maximage {
				display:none;/* Only use this if you fade it in again after the images load */
				position:fixed !important;
			}
			
			/*Set my gradient above all images*/
			#gradient {
				left:0;
				height:100%;
				position:absolute;
				top:0;
				width:100%;
				z-index:999;
			}
			
			/*Set my logo in bottom left*/
			#logo {
				bottom:30px;
				height:auto;
				left:30px;
				position:absolute;
				width:34%;
				z-index:1000;
			}
			#logo img {
				width:100%;
			}
			
			#arrow_left, #arrow_right {
				bottom:30px;
				height:67px;
				position:absolute;
				right:30px;
				width:36px;
				z-index:1000;
			}
			#arrow_left {
				right:86px;
			}
			
			#arrow_left:hover, #arrow_right:hover {
				bottom:29px;
			}
			#arrow_left:active, #arrow_right:active {
				bottom:28px;
			}
			
			a {color:#666;text-decoration:none;}
			a:hover {text-decoration:underline;}
			
			.in-slide-content { 
				color:#333;
				float:right;
				font-family:'Helvetica Neue', helvetica;
				line-height:2;
				font-weight:bold;
				margin:40px;
				padding:20px;
				position:absolute;
				top:0;
				width:800px;
				z-index:9999; /* Show above .gradient */
				text-shadow: 0 1px 0 #fff;
				-webkit-font-smoothing:antialiased;
			}
			.in-slide-content h2{
			    font-size:40px;
			}
			
			.in-slide-content p{
			    font-size:20px;
			}
			.en{
			    left:0;
			}
			.arabic{
			    right:0;
			    text-align: right;
			}
			.light-text {color:#ddd;text-shadow: 0 1px 0 #666;}
			.smaller-text {font-size:30px;}
			.youtube-video, video {
				left:0;
				position:absolute;
				top:0;
			}
		</style>
    </head>
    
    <body onload="pageLoaded()">

		<img id="cycle-loader" src="lib/images/ajax-loader.gif" />
		<div id="maximage">
			<!--<img data-href="0.000001" id='gradient' src='lib/images/fadepx.jpg' alt='' id='remove-me' />-->
			
		</div>
        
        <script>
        
        var dirty = false;
        var vids = 0;
        var first = true;
        var minVidDuration = Number.MAX_VALUE;
        //Run on page load complete
            function pageLoaded()
            {
                console.log("Page loaded");
                
                //Get the XML
                var xhttp = new XMLHttpRequest();
                xhttp.open("GET", "/loadxml.php?t="+Math.random(), true);
                
                //When we have received data
                xhttp.onreadystatechange = function()
                {
                    //Check was successful
                    if(this.readyState == 4 && this.status == 200)
                    {
                        var slides = JSON.parse(this.responseText); //parse it into a JS array of objects
                        
                        
                        console.log("Slides: " + slides); //remove the ones with enabled = no
                        slides = slides.filter(function(slide){
                        	return (slide['@attributes'].enabled == 'yes')
                        });
                        console.log("Slides: " + slides); //remove the ones with enabled = no
                        
                        if(slides.length < 2){
                        	alert("There are not enough slides for a slideshow. Please include more than one slide.");
                        	return;
                        }
                        
                        //Get the maximage element
                        var slideshow_div = document.getElementById("maximage");
                        
                        //Populate the list
                        slides.forEach(function(element){
                            
                            //Create their node within div#maximage
                            var slide = document.createElement("div");
                            
                            if(element['@attributes'].type == 'video')
                            {
                                var video_url = element.background;
                                
                                //Create video
                                slide.className = 'video ' + (first)?'first-item':'';
                                slide.innerHTML = "<img src='lib/images/fadepx.jpg' alt=''/><video muted='muted' preload='auto' width='640' height='360'  autobuffer='autobuffer' ><source src='"+video_url+"' type='video/mp4' />Your browser does not support HTML5 videos.</video>";
  
								//Wait until we know the duration of all our videos - this requires the video to have duration metadata (which most do)
                                slide.getElementsByTagName('video')[0].addEventListener('durationchange', vidLoaded);
                                vids++;
                                
                            }else{
                                //Create vars we'll need for our image/text
                                var background_image = element.background;
                                var english_title = element.english.title;
                                var arabic_title = element.arabic.title;
                                var english_description = element.english.description;
                                var arabic_description = element.arabic.description;
                                var duration = parseFloat(element['@attributes'].fadetime);

                                //Create pic and stuff
                                slide.innerHTML = "<img data-href='"+duration+"' src='"+ background_image +"' alt=''  /><img id='gradient' src='lib/images/demo/gradient.png' alt='' /><div class='in-slide-content en' style='display:none;'><h2>"+english_title+"</h2><p>"+english_description+"</p></div><div class='in-slide-content arabic' style='display:none;'><h2>"+ arabic_title +"</h2><p>"+ arabic_description +"</p></div>"
								slide.className = (first)?'first-item':'';
                            }
                            first = false;
                            slideshow_div.appendChild(slide);

                        });
                        
                        if(vids==0)startSlideshow();
                        
                    }
                }
                
                //Get doc asynchronously
                xhttp.send();
            }
            
            function startSlideshow()
                        {
                        	$('#maximage').maximage({
								cycleOptions: {
									fx: 'fade',
									speed: 1000, // Has to match the speed for CSS transitions in jQuery.maximage.css (lines 30 - 33)
									timeoutFn: function(currElement, nextElement, opts, isForward) { //use a custom function to change the timing (if its a video, we want the full video duration)
									    if($(currElement).find('video').length > 0) //this is not checking the length of the video, but the number of children which are of type video
									    {
									    	console.log("Duration: " + (isNaN($(currElement).find('video').get(0).duration)) ? minVidDuration:$(currElement).find('video').get(0).duration);
									        return ((isNaN($(currElement).find('video').get(0).duration))?minVidDuration:$(currElement).find('video').get(0).duration)*1000;
									        
									    }else{
									        return parseFloat($(currElement).attr('data-href'))*1000;
									    }
			                        },
									prev: '#arrow_left',
									next: '#arrow_right',
									pause: 1,
									before: function(last,current){
										// Start HTML5 video when you arrive
										if($(current).find('video').length > 0) $(current).find('video')[0].play();
									},
									after: function(last,current){
										// Pauses HTML5 video when you leave it
										if(dirty){
											if($(last).find('video').length > 0){
												$(last).find('video')[0].pause(); //don't call on the first slide!
												$(last).find('video')[0].currentTime = 0;
											} 
											
										}else{
											dirty = true;
										}

									}
								},
								onFirstImageLoaded: function(){
									jQuery('#cycle-loader').hide();
									jQuery('#maximage').fadeIn('fast');
									
								}
							});
	
							// Helper function to Fill and Center the HTML5 Video
							jQuery('video,object').maximage('maxcover');
				
							// To show it is dynamic html text
							jQuery('.in-slide-content').delay(1200).fadeIn();
                        }
                        
                        function vidLoaded(evt)
                        {
                        	if(evt.target.duration < minVidDuration)minVidDuration = evt.target.duration;
                        	vids--;
                        	
                        	if(vids == 0)
                        	{
                        		//run the rest
                        		console.log("vids all loaded");
                        		
                        		startSlideshow();
                        	}
                        }
            
        
            //If the user presses space we need to navigate to our edit mode
            Mousetrap.bind('space', function(e) {
                window.location.href = "/edit/slideshow.html";
                
            });
        </script>
    </body>
</html>