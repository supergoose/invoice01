<html>
    <head>
        <title>Edit Slideshow</title>
        <script type="text/javascript" src="../lib/js/mousetrap.js"></script>
    </head>
    <body onload="pageLoaded();">
        <h1>Edit</h1>
        <h2>Slides</h2>
        <ol id="slidelist">
        </ol>
        <p>Add slide</p>
        <script>
            
            var slides;
        
            //Run on page load complete
            function pageLoaded()
            {
                console.log("Page loaded");
                
                //Get the XML
                var xhttp = new XMLHttpRequest();
                xhttp.open("GET", "/loadxml.php?t="+Math.random(), true);
                
                //When we have received data
                xhttp.onreadystatechange = function()
                {
                    //Check was successful
                    if(this.readyState == 4 && this.status == 200)
                    {
                        var slides = JSON.parse(this.responseText); //parse it into a JS array of objects
                        
                        //Get the list element
                        var slidelist_element = document.getElementById("slidelist");
                        
                        //Populate the list
                        slides.forEach(function(element){
                            var slide_listitem = document.createElement("li");
                            var enbld = (element['@attributes'].enabled == "yes")? "Disable":"Enable";
                            slide_listitem.innerHTML = element.english.title + 
                            " <a href='#' onclick='toggleSlide("+element['@attributes'].id+")'>" + enbld + "</a>" +
                            " <a href='slide.php?slideId="+element['@attributes'].id+"'>Edit</a>" + 
                            " <a href='#' onclick='deleteSlide("+element['@attributes'].id+")'>Delete</a>";
                            slidelist_element.appendChild(slide_listitem);
                        });

                    }
                }
                
                //Get doc asynchronously
                xhttp.send();
            }
            
            function resetList()
            {
                //Get the list element
                var slidelist_element = document.getElementById("slidelist");
                
                slidelist_element.innerHTML = '';
                pageLoaded();
            }
            
            function toggleSlide(slideId)
            {
                console.log("Toggling: " + slideId);
                
                
                
                //Get the XML
                var xhttp = new XMLHttpRequest();
                xhttp.open("GET", "/toggleslide.php?slideId="+slideId+"&t="+Math.random(), true);
                
                //When we have received data
                xhttp.onreadystatechange = function()
                {
                    //Check was successful
                    if(this.readyState == 4 && this.status == 200)
                    {
                        console.log("successful");
                        
                        var list_element = document.getElementById("slidelist").childNodes[slideId+1];
                        
                        if(this.responseText == '1')
                        {
                            list_element.innerHTML = list_element.innerHTML.replace("Enable", "Disable");
                        }else{
                            list_element.innerHTML = list_element.innerHTML.replace("Disable", "Enable");
                        }

                    }
                }
                
                //Get doc asynchronously
                xhttp.send();
            }
            
            function deleteSlide(slideId)
            {
                if(!confirm("Are you sure you wish to delete this slide?"))
                {
                    return;
                }
                //Get the XML
                var xhttp = new XMLHttpRequest();
                xhttp.open("GET", "/deleteslide.php?slideId="+slideId+"&t="+Math.random(), true);
                
                //When we have received data
                xhttp.onreadystatechange = function()
                {
                    //Check was successful
                    if(this.readyState == 4 && this.status == 200)
                    {
                        console.log("delete successful: " + this.responseText);
                        
                        var list_element = document.getElementById("slidelist");
                        var child_element = list_element.childNodes[slideId+1];
                        list_element.removeChild(child_element);

                    }
                }
                
                //Get doc asynchronously
                xhttp.send();
            }

            //If the user presses space we need to navigate to our edit mode
            Mousetrap.bind('space', function(e) {
                window.location.href = "/run.html";
                
            });
            
            
        </script>
    </body>
</html>